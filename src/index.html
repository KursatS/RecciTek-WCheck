<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>RecciTek Garanti Sorgu Ge√ßmi≈üi</title>
  <style>
    :root {
      --bg-color: #f5f5f5;
      --card-bg: white;
      --text-color: #333;
      --border-color: #ddd;
      --button-bg: #4CAF50;
      --button-hover: #45a049;
      --filter-bg: #666;
      --filter-active: #4CAF50;
      --note-btn-bg: #2196F3;
      --note-btn-hover: #1976D2;
      --note-btn-has: #ff9800;
      --note-btn-has-hover: #f57c00;
      --modal-bg: rgba(0,0,0,0.5);
      --modal-content-bg: white;
      --modal-text: #333;
      --save-btn-bg: #4CAF50;
      --cancel-btn-bg: #f44336;
    }

    .dark {
      --bg-color: #2c2f33;
      --card-bg: #36393f;
      --text-color: #dcddde;
      --border-color: #202225;
      --button-bg: #4CAF50;
      --button-hover: #45a049;
      --filter-bg: #666;
      --filter-active: #4CAF50;
      --note-btn-bg: #2196F3;
      --note-btn-hover: #1976D2;
      --note-btn-has: #ff9800;
      --note-btn-has-hover: #f57c00;
      --modal-bg: rgba(0,0,0,0.7);
      --modal-content-bg: #36393f;
      --modal-text: #dcddde;
      --save-btn-bg: #4CAF50;
      --cancel-btn-bg: #f44336;
    }

    body {
       font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
       margin: 0;
       padding: 20px;
       background-color: var(--bg-color);
       color: var(--text-color);
       transition: background-color 0.3s, color 0.3s;
     }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: var(--text-color);
      font-weight: 500;
    }
    .controls {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      justify-content: center;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
    }
    .filter-btn {
      padding: 8px 16px;
      background: var(--filter-bg);
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .filter-btn.active {
      background: var(--filter-active);
    }
    .filter-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    #search {
      padding: 12px 20px;
      border: 1px solid #ddd;
      border-radius: 25px;
      font-size: 16px;
      width: 300px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #toggle {
      padding: 12px 20px;
      background: var(--button-bg);
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    #toggle:hover {
      background: var(--button-hover);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }
    .card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      position: relative;
      border: 3px solid transparent;
      color: var(--text-color);
    }
    .card.recci {
      border-color: #4CAF50;
    }
    .card.kvk {
      border-color: #2196F3;
    }
    .card.out-of-warranty {
      border-color: #f44336;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.2);
    }
    .favorite {
      position: absolute;
      top: 15px;
      right: 15px;
      cursor: pointer;
      font-size: 20px;
      color: #ffd700;
    }
    .card-content {
      margin-top: 10px;
    }
    .card p {
      margin: 8px 0;
      font-size: 16px;
      color: var(--text-color);
    }
    .card strong {
      color: var(--text-color);
      font-weight: 700;
    }
    .note-btn {
      margin-top: 15px;
      padding: 8px 16px;
      background: var(--note-btn-bg);
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .note-btn.has-note {
      background: var(--note-btn-has);
    }
    .note-btn:hover {
      background: var(--note-btn-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .note-btn.has-note:hover {
      background: var(--note-btn-has-hover);
    }
    .status-dropdown {
      margin-top: 10px;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-color);
      font-size: 14px;
    }

    /* Modal styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--modal-bg);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: var(--modal-content-bg);
      padding: 20px;
      border-radius: 10px;
      width: 450px;
      max-width: 90%;
      color: var(--modal-text);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .modal h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--modal-text);
      text-align: center;
    }
    .modal textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      resize: none;
      font-family: inherit;
      background: var(--card-bg);
      color: var(--text-color);
      margin: 10px 0;
    }
    .modal-buttons {
      margin-top: 15px;
      text-align: right;
      width: 100%;
    }
    .modal-buttons button {
      margin-left: 10px;
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
    }
    #save-note {
      background: var(--save-btn-bg);
      color: white;
    }
    #cancel-note {
      background: var(--cancel-btn-bg);
      color: white;
    }
  </style>
</head>
<body class="dark">
  <div class="container">
    <h1>RecciTek Garanti Sorgu Ge√ßmi≈üi</h1>
    <button id="theme-toggle" style="position: absolute; top: 0; right: 0; background: none; border: none; font-size: 24px; cursor: pointer;">üåô</button>
    <div class="controls">
      <input type="text" id="search" placeholder="Seri numarasƒ± ara...">
      <button id="toggle">üëÅÔ∏è Clipboard ƒ∞zlemeyi Devre Dƒ±≈üƒ± Bƒ±rak</button>
      <button id="lock-screen" style="background: linear-gradient(135deg, #9c27b0, #673ab7); color: white; border: none; border-radius: 25px; padding: 12px 20px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">Ekranƒ± Kilitle</button>
      <button id="clear-cache" style="background: linear-gradient(135deg, #f44336, #d32f2f); color: white; border: none; border-radius: 25px; padding: 12px 20px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">Cache Temizle</button>
    </div>
    <div class="filter-buttons">
      <button class="filter-btn active" data-filter="all">T√ºm√º</button>
      <button class="filter-btn" data-filter="favorites">Favoriler</button>
      <button class="filter-btn" data-filter="notes">Notlu</button>
      <button class="filter-btn" id="sort-btn" data-sort="desc">üìÖ Yeniden Eskiye</button>
    </div>
    <div class="cards-grid" id="cards"></div>
  </div>

  <!-- Note Modal -->
  <div id="note-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>Not Ekle/D√ºzenle</h3>
      <textarea id="note-text" rows="4" placeholder="Notunuzu buraya yazƒ±n..."></textarea>
      <div class="modal-buttons">
        <button id="save-note">Kaydet</button>
        <button id="cancel-note">ƒ∞ptal</button>
      </div>
    </div>
  </div>

  <script>
    console.log('Index HTML loaded');

    // Inline renderer script
    const { ipcRenderer } = require('electron');

    console.log('Renderer script starting...');

    const cardsDiv = document.getElementById('cards');
    const searchInput = document.getElementById('search');
    const toggleBtn = document.getElementById('toggle');

    console.log('DOM elements found:', {
      cardsDiv: !!cardsDiv,
      searchInput: !!searchInput,
      toggleBtn: !!toggleBtn
    });

    let monitoringEnabled = true;
    let currentFilter = 'all';

    toggleBtn.onclick = () => {
      console.log('Toggle button clicked, current state:', monitoringEnabled);
      monitoringEnabled = !monitoringEnabled;
      toggleBtn.textContent = monitoringEnabled ? 'üëÅÔ∏è Clipboard ƒ∞zlemeyi Devre Dƒ±≈üƒ± Bƒ±rak' : 'üëÅÔ∏è Clipboard ƒ∞zlemeyi Etkinle≈ütir';
      console.log('Sending toggle-monitoring:', monitoringEnabled);
      ipcRenderer.send('toggle-monitoring', monitoringEnabled);
    };

    searchInput.oninput = () => {
      loadCards();
    };

    let currentSort = 'desc';

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (btn.id === 'sort-btn') {
          currentSort = currentSort === 'asc' ? 'desc' : 'asc';
          btn.textContent = currentSort === 'asc' ? 'üìÖ Eskiden Yeniye' : 'üìÖ Yeniden Eskiye';
        } else {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
        }
        loadCards();
      });
    });

    // Clear cache button
    const clearCacheBtn = document.getElementById('clear-cache');
    if (clearCacheBtn) {
      clearCacheBtn.addEventListener('click', () => {
        if (confirm('Favoriye eklenen cihazlar hari√ß t√ºm cihazlarƒ± silmek istediƒüinizden emin misiniz?')) {
          ipcRenderer.invoke('clear-cache').then(() => {
            loadCards();
          });
        }
      });
    }

    // Lock screen button
    const lockScreenBtn = document.getElementById('lock-screen');
    if (lockScreenBtn) {
      lockScreenBtn.addEventListener('click', () => {
        ipcRenderer.send('toggle-lock-screen');
      });
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return `${date.getDate().toString().padStart(2, '0')}.${(date.getMonth() + 1).toString().padStart(2, '0')}.${date.getFullYear()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
    }

    function loadCards() {
      console.log('loadCards called');
      ipcRenderer.invoke('get-cached-data').then((data) => {
        console.log('Received data:', data);
        cardsDiv.innerHTML = '';
        const query = searchInput.value.toLowerCase();

        // Sort data by copy date
        data.sort((a, b) => {
          const dateA = new Date(a.copy_date);
          const dateB = new Date(b.copy_date);
          return currentSort === 'asc' ? dateA.getTime() - dateB.getTime() : dateB.getTime() - dateA.getTime();
        });

        data.forEach(item => {
          let shouldShow = false;
          if (currentFilter === 'all') {
            shouldShow = item.serial.toLowerCase().includes(query);
          } else if (currentFilter === 'favorites') {
            shouldShow = item.is_favorite && item.serial.toLowerCase().includes(query);
          } else if (currentFilter === 'notes') {
            shouldShow = item.has_note && item.serial.toLowerCase().includes(query);
          }

          if (shouldShow) {
            const card = document.createElement('div');
            let cardClass = 'card';
            if (item.warranty_status.includes('RECCI')) {
              cardClass += ' recci';
            } else if (item.warranty_status.includes('KVK')) {
              cardClass += ' kvk';
            } else {
              cardClass += ' out-of-warranty';
            }
            card.className = cardClass;
            card.innerHTML = `
              <span class="favorite" onclick="toggleFavorite('${item.serial}')">${item.is_favorite ? '‚≠ê' : '‚òÜ'}</span>
              <div class="card-content">
                <p><strong>Seri Numarasƒ±:</strong> ${item.serial}</p>
                <p><strong>Model:</strong> ${item.model_name} - ${item.model_color}</p>
                <p><strong>Garanti Durumu:</strong> ${item.warranty_status}</p>
                <p><strong>Kopyalama Tarihi:</strong> ${formatDate(item.copy_date)}</p>
                ${item.warranty_end ? `<p><strong>Garanti Biti≈ü:</strong> ${item.warranty_end}</p>` : ''}
                <button class="note-btn ${item.has_note ? 'has-note' : ''}" onclick="addNote('${item.serial}')">${item.has_note ? 'Notu Deƒüi≈ütir' : 'Not Ekle'}</button>
                <select class="status-dropdown" onchange="updateStatus('${item.serial}', this.value)">
                  <option value="">Durum Se√ß</option>
                  <option value="ARIZA EKSƒ∞K" ${item.status === 'ARIZA EKSƒ∞K' ? 'selected' : ''}>ARIZA EKSƒ∞K</option>
                  <option value="ADRES EKSƒ∞K" ${item.status === 'ADRES EKSƒ∞K' ? 'selected' : ''}>ADRES EKSƒ∞K</option>
                  <option value="ARIZA VE ADRES EKSƒ∞K" ${item.status === 'ARIZA VE ADRES EKSƒ∞K' ? 'selected' : ''}>ARIZA VE ADRES EKSƒ∞K</option>
                  <option value="SERVƒ∞S KAYIT FORMU EKSƒ∞K" ${item.status === 'SERVƒ∞S KAYIT FORMU EKSƒ∞K' ? 'selected' : ''}>SERVƒ∞S KAYIT FORMU EKSƒ∞K</option>
                  <option value="Dƒ∞ƒûER" ${item.status === 'Dƒ∞ƒûER' ? 'selected' : ''}>Dƒ∞ƒûER</option>
                </select>
              </div>
            `;
            cardsDiv.appendChild(card);
          }
        });
      }).catch(error => {
        console.error('Error loading cards:', error);
      });
    }

    loadCards();

    // Listen for refresh event
    ipcRenderer.on('refresh-cards', () => {
      loadCards();
    });

    // Listen for lock screen toggle
    ipcRenderer.on('lock-screen-toggled', (event, enabled) => {
      const lockBtn = document.getElementById('lock-screen');
      if (lockBtn) {
        lockBtn.textContent = enabled ? 'Ekran Kilidini A√ß' : 'Ekranƒ± Kilitle';
      }
    });

    // Global functions for card interactions
    window.toggleFavorite = async (serial) => {
      await ipcRenderer.invoke('toggle-favorite', serial);
      loadCards();
    };

    let currentSerial = '';

    // Theme toggle
    document.getElementById('theme-toggle').onclick = () => {
      document.body.classList.toggle('dark');
      const isDark = document.body.classList.contains('dark');
      document.getElementById('theme-toggle').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
    };

    // Make functions available globally
    window.toggleFavorite = async (serial) => {
      await ipcRenderer.invoke('toggle-favorite', serial);
      loadCards();
    };

    window.addNote = async (serial) => {
      const existingNote = await ipcRenderer.invoke('get-note', serial);
      const modal = document.getElementById('note-modal');
      const textArea = document.getElementById('note-text');
      textArea.value = existingNote || '';
      modal.style.display = 'flex';

      // Handle save
      document.getElementById('save-note').onclick = async () => {
        const note = textArea.value;
        await ipcRenderer.invoke('save-note', serial, note);
        modal.style.display = 'none';
        loadCards();
      };

      // Handle cancel
      document.getElementById('cancel-note').onclick = () => {
        modal.style.display = 'none';
      };
    };

    window.updateStatus = async (serial, status) => {
      await ipcRenderer.invoke('save-status', serial, status);
      loadCards();
    };
  </script>
</body>
</html>